<!DOCTYPE html>
<meta charset="utf-8">
<style>
  div.tooltip { 
    position: absolute;     
    text-align: center;     
    width: auto;          
    height: auto;         
    padding: 2px;       
    font: 12px sans-serif;    
    background: lightsteelblue; 
    border: 0px;    
    border-radius: 8px;     
    pointer-events: none;     
  }
  div.loading {   
  position: absolute;  
  left: 45%;
  top: 30%;         
  text-align: center;           
  width: 125px;                  
  height: 50px;                 
  padding: 2px;             
  font: 12px sans-serif;        
  border: 0px;      
  border-radius: 8px;  
  pointer-events: none;
}
.legend {
	display:none;
}
</style>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<div style="position:absolute; top:35px;width:100%;height:100%"><svg id="dataviz" width="100%" height="100%"></svg></div>
<script>

const w = window.innerWidth;
const h = window.innerHeight;
console.log(w, h);

var div = d3.select("body").append("div") 
  .attr("class", "tooltip")       
  .style("opacity", 0);

var svg = d3.select("svg");//,
  width =w/2;//500,
  height =h*(2/3);//600;



var path = d3.geoPath();
var projection = d3.geoMercator()
  .center([-3, 56.3]) //center([-3, 56])                 
  //.scale(2200) 
  //.scale(h*3 - 250)
  .scale(1910)
  .translate([width / 2, height / 2]); 
//900x600: width=w/3 , height=h*2/3 , scale=1910, center=[-4, 56.3]

const zoom = d3.zoom()
  .scaleExtent([1,8])
  .on('zoom', zoomed);
  //.on('wheel.zoom', zoomed);

var data = d3.map();

d3.queue()
  .defer(d3.json, "uk_la.geojson")
  .defer(d3.csv, "data.csv", function(d) {
  		data.set(d.name, [+d.rate_day, d.lockdown, d.cases_day, d.rate_week, d.trend, d.cases_week]); 
  	})
  .await(ready);
const g = svg.append('g');
function ready(error, topo) {
  $('.loading').hide();
  $('.legend').show();

  

  g
    .selectAll("path")
    .data(topo.features)
    .enter()
    .append("path")
      .attr("d", d3.geoPath()
        .projection(projection)
      )
      .attr("stroke", function(d) {
      	//"black"
      	d.lockdown = (typeof data.get(d.properties.lad18nm) == "undefined") ? "unavailable":data.get(d.properties.lad18nm)[1];
      	if (d.lockdown == "Restricted" || d.lockdown == "Partly Restricted" || d.lockdown == "Significantly Restricted") {
      		return "black";
      	}
      	else if (d.lockdown == "Area of Concern") {
      		return "blue";
      	}
      	else {
      		return "grey";
      	}
      })
      .attr("fill", function (d) {
        //d.total = data.get(d.properties.lad18nm) || "unavailable";
        d.total = (typeof data.get(d.properties.lad18nm) == "undefined") ? "unavailable":data.get(d.properties.lad18nm)[0];
        if (d.total < 1) { return "green";}
        else if (d.total < 10) {return "yellow";}
        else if (d.total < 25) {return "orange";}
        else if (d.total >= 25) {return "red";}
        else {return "silver";}
      })
      .on("mouseover", function(d) { 
      		d.cases = (typeof data.get(d.properties.lad18nm) == "undefined") ? "unavailable":data.get(d.properties.lad18nm)[2];
      		d.trend = (typeof data.get(d.properties.lad18nm) == "undefined") ? "unavailable":data.get(d.properties.lad18nm)[4];
      		d.weekly = (typeof data.get(d.properties.lad18nm) == "undefined") ? "unavailable":data.get(d.properties.lad18nm)[3];
          d.cases_week = (typeof data.get(d.properties.lad18nm) == "undefined") ? "unavailable":data.get(d.properties.lad18nm)[5];
      		var mouseover_txt = "<strong><u>" + d.properties.lad18nm + "</strong></u><br/>";
      		if (d.total == "unavailable") {
      			mouseover_txt += "No Data Available";
      		}   
      		else {
      			mouseover_txt = mouseover_txt + "Daily cases per 100k: " + d.total + "<br/>" + "Weekly cases per 100k: " + d.weekly ;
            if(d.trend == "▲") {mouseover_txt = mouseover_txt + "<label style='color:red'>" + d.trend + "</label>";}
            else if (d.trend == "▼") {mouseover_txt = mouseover_txt + "<label style='color:green'>" + d.trend + "</label>";}
            else {mouseover_txt = mouseover_txt + "<label>" + d.trend + "</label>";}
            mouseover_txt = mouseover_txt + "<br/>New cases today: " + d.cases + "<br/>New cases past week: " + d.cases_week + "<br/><i>" + d.lockdown + "</i>";
      		}
            div.transition()    
                .duration(200)    
                .style("opacity", .9);    
            div .html(/*d.properties.lad18nm + "<br/>"  + d.total + " daily case rate per 100k" + "<br/>" + d.lockdown */
            	mouseover_txt)  
                .style("left", (d3.event.pageX) + "px")   
                .style("top", (d3.event.pageY - 28) + "px");  
            })          
        .on("mouseout", function(d) {   
            div.transition()    
                .duration(500)    
                .style("opacity", 0); 
        })
        .on("click", function(d) { 
        	d.cases = (typeof data.get(d.properties.lad18nm) == "undefined") ? "unavailable":data.get(d.properties.lad18nm)[2];
      		d.trend = (typeof data.get(d.properties.lad18nm) == "undefined") ? "unavailable":data.get(d.properties.lad18nm)[4];
      		d.weekly = (typeof data.get(d.properties.lad18nm) == "undefined") ? "unavailable":data.get(d.properties.lad18nm)[3];
          d.cases_week = (typeof data.get(d.properties.lad18nm) == "undefined") ? "unavailable":data.get(d.properties.lad18nm)[5];
      		var mouseover_txt = "<strong>" + d.properties.lad18nm + "</strong><br/>";
      		if (d.total == "unavailable") {
      			mouseover_txt += "No Data Available";
      		}   
      		else {
      			mouseover_txt = mouseover_txt + "Daily cases per 100k: " + d.total + "<br/>" + "Weekly cases per 100k: " + d.weekly ;
      			if(d.trend == "▲") {mouseover_txt = mouseover_txt + "<label style='color:red'>" + d.trend + "</label>";}
      			else if (d.trend == "▼") {mouseover_txt = mouseover_txt + "<label style='color:green'>" + d.trend + "</label>";}
      			else {mouseover_txt = mouseover_txt + "<label>" + d.trend + "</label>";}
      			mouseover_txt = mouseover_txt + "<br/>New cases today: " + d.cases + "<br/>New cases past week: " + d.cases_week + "<br/><i>" + d.lockdown + "</i>";
      		}   
            div.transition()    
                .duration(200)    
                .style("opacity", .9);    
            div .html(/*d.properties.lad18nm + "<br/>"  + d.total + " daily case rate per 100k"*/mouseover_txt)  
                .style("left", (d3.event.pageX) + "px")   
                .style("top", (d3.event.pageY - 28) + "px");  
            })          ;
    }
    svg.append("circle").attr("cx",275).attr("cy",130).attr("r", 6).style("fill", "green").attr("class", "legend")
	svg.append("circle").attr("cx",275).attr("cy",150).attr("r", 6).style("fill", "yellow").attr("class", "legend")
	svg.append("circle").attr("cx",275).attr("cy",170).attr("r", 6).style("fill", "orange").attr("class", "legend")
	svg.append("circle").attr("cx",275).attr("cy",190).attr("r", 6).style("fill", "red").attr("class", "legend")
	svg.append("rect").attr("x",275).attr("y",210).attr("width", 10).attr("height", 2).style("fill", "black").attr("class", "legend")
	svg.append("rect").attr("x",275).attr("y",230).attr("width", 10).attr("height", 2).style("fill", "blue").attr("class", "legend")
	svg.append("text").attr("x", 295).attr("y", 130).text("On Track for Containment (<1 daily case per 100k): Monitor with test and trace").style("font-size", "15px").attr("alignment-baseline","middle").attr("class", "legend")
	svg.append("text").attr("x", 295).attr("y", 150).text("Community Spread (1-9 daily cases per 100k): Rigorous test and trace advised").style("font-size", "15px").attr("alignment-baseline","middle").attr("class", "legend")
	svg.append("text").attr("x", 295).attr("y", 170).text("Accelerated Spread (10-24 daily cases per 100k): Stay-at-home orders advised").style("font-size", "15px").attr("alignment-baseline","middle").attr("class", "legend")
	svg.append("text").attr("x", 295).attr("y", 190).text("Tipping Point (25+ daily cases per 100k): Stay-at-home orders necessary").style("font-size", "15px").attr("alignment-baseline","middle").attr("class", "legend")
	svg.append("text").attr("x", 295).attr("y", 210).text("Severely Restricted, Restricted, or Partially Restricted").style("font-size", "15px").attr("alignment-baseline","middle").attr("class", "legend")
	svg.append("text").attr("x", 295).attr("y", 230).text("Area of Concern").style("font-size", "15px").attr("alignment-baseline","middle").attr("class", "legend")

svg.call(zoom);

function zoomed() {
      g
        .selectAll('path') // To prevent stroke width from scaling
        .attr('transform', d3.event.transform);
    }

d3.csv("data.csv", function(data){

    var totalSum = d3.sum(data.map(function(d){ return d.cases_day}));
    svg.append("text").attr("x", 275).attr("y", 65).text("Total New Daily Cases (N. Irleand not included): "+ totalSum + " " + w + "x" + h);


});

</script>
<body>
	<div style="position:absolute;top:0px;"><strong>UK COVID-19 Risk Levels by Local Authority</strong> (Data updated 15 Sept 2020, provided by PHE)<br /> </div>
	<div style="position:absolute;top:20px;font-size:12px"> Based on the <a href="https://globalepidemics.org/key-metrics-for-covid-suppression/" target="_blank">Key Metrics for COVID Supression </a> framework. Risk levels calculated based on daily cases per 100,000 population (7 day rolling average). Hover over an area for details.
	</div>
	<div class="loading"><font size=4>Loading...</font><p /><img src="load_icon.gif" style="width:150px;"/></div>

</body>